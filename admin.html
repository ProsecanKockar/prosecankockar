<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Panel - Prosečan Kockar</title>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<style>
body {
background-color: #121212;
color: #f1f1f1;
font-family: 'Segoe UI', sans-serif;
padding: 20px;
}

h1 {
color: #00ffcc;
}

.match {
background-color: #1e1e1e;
padding: 15px;
margin-bottom: 10px;
border-radius: 8px;
box-shadow: 0 0 5px #00ffcc33;
}

select, button {
padding: 6px;
margin-top: 5px;
background-color: #00ffcc;
color: black;
font-weight: bold;
border: none;
border-radius: 4px;
cursor: pointer;
}

select {
background-color: #2c2c2c;
color: white;
}

.success {
color: #00ffcc;
margin-top: 10px;
}
</style>
</head>
<body>
<h1>Admin Panel</h1>
<div id="matchList">Učitavanje mečeva...</div>
<div id="adminMsg"></div>

<script>
const firebaseConfig = {
apiKey: "AIzaSyB6HgVAePwyqCmMZFC_-xOgOF-gZLT9g20",
authDomain: "prosecankockar-a1c15.firebaseapp.com",
projectId: "prosecankockar-a1c15",
storageBucket: "prosecankockar-a1c15.appspot.com",
messagingSenderId: "968186282419",
appId: "1:968186282419:web:8e92d1926e53150a9c0bc6"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function loadMatches() {
const container = document.getElementById("matchList");
container.innerHTML = "";

const snapshot = await db.collection("matches").get();
snapshot.forEach(doc => {
const data = doc.data();

const div = document.createElement("div");
div.className = "match";

div.innerHTML = `
<strong>${data.teams}</strong><br/>
<label>Postavi rezultat:</label>
<select id="result-${doc.id}">
<option value="">Izaberi pobednika</option>
<option value="${data.team1}">${data.team1}</option>
<option value="${data.team2}">${data.team2}</option>
</select>
<button onclick="submitResult('${doc.id}', '${data.team1}', '${data.team2}')">Potvrdi</button>
`;

container.appendChild(div);
});
}

async function submitResult(matchId, team1, team2) {
const selectedResult = document.getElementById(`result-${matchId}`).value;
const msg = document.getElementById("adminMsg");

if (!selectedResult) {
msg.innerHTML = `<div class='error'>Morate izabrati rezultat.</div>`;
return;
}

// Ažuriraj rezultat meča
await db.collection("matches").doc(matchId).update({
result: selectedResult
});

// Pronađi sve opklade na ovaj meč
const betsSnapshot = await db.collection("bets").where("match", "==", `${team1} vs ${team2}`).get();
const batch = db.batch();

betsSnapshot.forEach(betDoc => {
const betData = betDoc.data();
const betRef = db.collection("bets").doc(betDoc.id);

// Ažuriraj rezultat opklade
batch.update(betRef, { result: selectedResult });

// Ako je pogodio, vrati mu duplo
if (betData.prediction === selectedResult) {
const userRef = db.collection("users").doc(betData.userId);
batch.update(userRef, {
balance: firebase.firestore.FieldValue.increment(betData.stake * 2)
});
}
});

await batch.commit();
msg.innerHTML = `<div class='success'>Rezultat unet i opklade obrađene!</div>`;
}

loadMatches();
</script>
</body>
</html>
