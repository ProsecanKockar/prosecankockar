<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard - Prosečan Kockar</title>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<style>
body {
background-color: #121212;
color: #f1f1f1;
font-family: 'Segoe UI', sans-serif;
margin: 0;
padding: 20px;
}

h1, h2 {
color: #00ffcc;
}

.saldo {
margin-bottom: 20px;
font-size: 18px;
}

.match, .bet {
background-color: #1e1e1e;
padding: 15px;
margin-bottom: 10px;
border-radius: 8px;
box-shadow: 0 0 5px #00ffcc33;
}

select, input[type="number"] {
padding: 6px;
border-radius: 4px;
margin-right: 10px;
background-color: #2c2c2c;
color: white;
border: none;
}

button {
padding: 8px 14px;
background-color: #00ffcc;
color: #000;
border: none;
border-radius: 4px;
cursor: pointer;
font-weight: bold;
transition: background 0.3s;
}

button:hover {
background-color: #00ccaa;
}

.bets, .past-bets, .ranking {
margin-top: 30px;
}

.success {
color: #00ffcc;
margin-top: 10px;
}

.error {
color: red;
margin-top: 10px;
}
</style>
</head>
<body>
<h1>Dobrodošao na Prosečan Kockar</h1>
<div class="saldo" id="userSaldo">Učitavanje salda...</div>
<div id="mecevi"></div>
<div id="message"></div>

<div class="bets">
<h2>Aktivne opklade</h2>
<div id="aktivneOpklade"></div>
</div>

<div class="past-bets">
<h2>Prošle opklade</h2>
<div id="prosleOpklade"></div>
</div>

<div class="ranking">
<h2>Rang lista</h2>
<div id="rankingList"></div>
</div>

<script>
const firebaseConfig = {
apiKey: "AIzaSyB6HgVAePwyqCmMZFC_-xOgOF-gZLT9g20",
authDomain: "prosecankockar-a1c15.firebaseapp.com",
projectId: "prosecankockar-a1c15",
storageBucket: "prosecankockar-a1c15.appspot.com",
messagingSenderId: "968186282419",
appId: "1:968186282419:web:8e92d1926e53150a9c0bc6"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;

auth.onAuthStateChanged(async user => {
if (!user) {
window.location.href = "register.html";
return;
}

currentUser = user;
await ensureUserExists(user);
loadUserSaldo();
loadMatches();
loadUserBets();
loadRanking();
});

async function ensureUserExists(user) {
const userRef = db.collection("users").doc(user.uid);
const doc = await userRef.get();
if (!doc.exists) {
await userRef.set({
balance: 1000,
email: user.email,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
});
}
}

async function loadUserSaldo() {
const doc = await db.collection("users").doc(currentUser.uid).get();
const data = doc.data();
document.getElementById("userSaldo").innerText = `Tvoj saldo: ${data.balance} RSD`;
}

async function loadMatches() {
const container = document.getElementById("mecevi");
const snapshot = await db.collection("matches").get();
container.innerHTML = "<h2>Dostupni mečevi</h2>";

snapshot.forEach(doc => {
const data = doc.data();
const div = document.createElement("div");
div.className = "match";

div.innerHTML = `
<strong>${data.teams}</strong><br/>
<label>Predikcija:</label>
<select id="prediction-${doc.id}">
<option value="${data.team1}">${data.team1}</option>
<option value="${data.team2}">${data.team2}</option>
</select>
<input type="number" id="stake-${doc.id}" placeholder="Ulog" min="1" />
<button onclick="placeBet('${doc.id}', '${data.teams}')">Kladjenje</button>
`;

container.appendChild(div);
});
}

async function placeBet(matchId, teams) {
const prediction = document.getElementById(`prediction-${matchId}`).value;
const stake = parseInt(document.getElementById(`stake-${matchId}`).value);
const msg = document.getElementById("message");
msg.innerHTML = "";

if (!stake || stake <= 0) {
msg.innerHTML = `<div class='error'>Unesite validan ulog.</div>`;
return;
}

const userRef = db.collection("users").doc(currentUser.uid);
const userDoc = await userRef.get();
const userData = userDoc.data();

if (stake > userData.balance) {
msg.innerHTML = `<div class='error'>Nemate dovoljno sredstava.</div>`;
return;
}

await db.collection("bets").add({
userId: currentUser.uid,
match: teams,
prediction,
stake,
result: null,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
});

await userRef.update({
balance: firebase.firestore.FieldValue.increment(-stake)
});

msg.innerHTML = `<div class='success'>Opklada postavljena!</div>`;
loadUserSaldo();
loadUserBets();
}

async function loadUserBets() {
const activeContainer = document.getElementById("aktivneOpklade");
const pastContainer = document.getElementById("prosleOpklade");
activeContainer.innerHTML = "";
pastContainer.innerHTML = "";

const snapshot = await db.collection("bets")
.where("userId", "==", currentUser.uid)
.orderBy("createdAt", "desc")
.get();

snapshot.forEach(doc => {
const data = doc.data();
const div = document.createElement("div");
div.className = "bet";
div.innerHTML = `<strong>${data.match}</strong><br/>Predikcija: ${data.prediction}<br/>Ulog: ${data.stake} RSD`;

if (data.result === null) {
activeContainer.appendChild(div);
} else {
div.innerHTML += `<br/>Rezultat: ${data.result} (${data.result === data.prediction ? "Pobeda" : "Poraz"})`;
pastContainer.appendChild(div);
}
});
}

async function loadRanking() {
const container = document.getElementById("rankingList");
const snapshot = await db.collection("users").orderBy("balance", "desc").limit(10).get();

let rank = 1;
snapshot.forEach(doc => {
const data = doc.data();
const div = document.createElement("div");
div.className = "bet";
div.innerText = `${rank}. ${data.email || "Korisnik"} - ${data.balance} RSD`;
container.appendChild(div);
rank++;
});
}
</script>
</body>
</html>
